<h1>All Tax Forms</h1>

<div class="actions" style="margin-bottom: 20px;">
  <a href="<%= new_admin_form_path %>" class="button" style="padding: 10px 20px; display: inline-block;">Add New Form</a>

  <div class="preview-year-selector" style="display: inline-block; margin-left: 20px;">
    <%= form_with(url: admin_forms_path, method: :get) do |form| %>
      <%= form.label :preview_year, "Preview Year:", style: "margin-right: 10px;" %>
      <%= form.number_field :preview_year, value: params[:preview_year] || 2025, min: 2000, max: 2100, style: "padding: 8px; width: 100px;" %>
      <%= form.submit "Update Dates", class: "button", style: "padding: 8px 16px; margin-left: 10px;" %>
    <% end %>
  </div>
</div>

<% if @forms.any? %>
  <table style="width: 100%; border-collapse: collapse;">
    <thead>
    <tr>
      <th style="padding: 10px; border: 1px solid #ddd; background-color: #f4f4f4; text-align: left;">ID</th>
      <th style="padding: 10px; border: 1px solid #ddd; background-color: #f4f4f4; text-align: left;">Form Number</th>
      <th style="padding: 10px; border: 1px solid #ddd; background-color: #f4f4f4; text-align: left;">Form Name</th>
      <th style="padding: 10px; border: 1px solid #ddd; background-color: #f4f4f4; text-align: left;">Entity Type</th>
      <th style="padding: 10px; border: 1px solid #ddd; background-color: #f4f4f4; text-align: left;">Locality</th>
      <th style="padding: 10px; border: 1px solid #ddd; background-color: #f4f4f4; text-align: left;">Due Date</th>
      <th style="padding: 10px; border: 1px solid #ddd; background-color: #f4f4f4; text-align: left;">Extension Due Date</th>
      <th style="padding: 10px; border: 1px solid #ddd; background-color: #f4f4f4; text-align: left;">Needs Update?</th>
      <th style="padding: 10px; border: 1px solid #ddd; background-color: #f4f4f4; text-align: left;">Actions</th>
    </tr>
    </thead>
    <tbody>
    <% @forms.each_with_index do |form, index| %>
      <tr>
        <td style="padding: 10px; border: 1px solid #ddd;"><%= index + 1 %></td>
        <td style="padding: 10px; border: 1px solid #ddd;"><%= form['formNumber'] %></td>
        <td style="padding: 10px; border: 1px solid #ddd;"><%= form['formName'] %></td>
        <td style="padding: 10px; border: 1px solid #ddd;"><%= form['entityType'] %></td>
        <td style="padding: 10px; border: 1px solid #ddd;"><%= form['localityType'] %> - <%= form['locality'] %></td>

        <%
          preview_year = (params[:preview_year] || 2025).to_i
          calculator = DueDateCalculator.new
          preview_dates = calculator.calculate_dates(
            form['formNumber'],
            form['entityType'],
            form['localityType'],
            form['locality'],
            Date.new(preview_year, 1, 1),
            Date.new(preview_year, 12, 31)
          )

          approximated = preview_dates && preview_dates[:approximated]
        %>

        <td style="padding: 10px; border: 1px solid #ddd;<%= approximated ? 'background-color: #fff3cd;' : '' %>">
          <%= preview_dates && preview_dates[:due_date] ? preview_dates[:due_date].strftime('%m/%d/%Y') : 'Not calculated' %>
        </td>
        <td style="padding: 10px; border: 1px solid #ddd;<%= approximated ? 'background-color: #fff3cd;' : '' %>">
          <%= preview_dates && preview_dates[:extension_due_date] ? preview_dates[:extension_due_date].strftime('%m/%d/%Y') : 'N/A' %>
        </td>
        <td style="padding: 10px; border: 1px solid #ddd;">
          <% if !preview_dates %>
            <span style="background-color: #fff3cd; color: #856404; padding: 3px 6px; border-radius: 3px;">Yes - Missing Year</span>
          <% elsif approximated %>
            <span style="background-color: #fff3cd; color: #856404; padding: 3px 6px; border-radius: 3px;">Yes - Approximated</span>
          <% else %>
            <span>No</span>
          <% end %>
        </td>
        <td style="padding: 10px; border: 1px solid #ddd;">
          <a href="<%= edit_admin_form_path(index + 1) %>" class="button" style="display: inline-block; padding: 6px 12px; margin-right: 5px; background-color: #4CAF50; color: white; text-decoration: none; border-radius: 4px;">Edit</a>
          <%= button_to "Delete", admin_form_path(index + 1), method: :delete, data: { turbo_confirm: "Are you sure?" }, class: "button", style: "display: inline-block; padding: 6px 12px; background-color: #d9534f; color: white; border: none; border-radius: 4px; cursor: pointer;" %>
        </td>
      </tr>
    <% end %>
    </tbody>
  </table>
<% else %>
  <p>No forms found.</p>
<% end %>